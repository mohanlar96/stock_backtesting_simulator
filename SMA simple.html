<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Backtesting Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1000px;
        }

        .bg-gradient-glass {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #loading-spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="h-full flex flex-col items-center p-4 text-slate-100">

    <div class="container w-full p-6 space-y-8 rounded-2xl bg-gradient-glass shadow-xl mt-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center tracking-tight text-white">Stock Backtesting Tool</h1>
        <p class="text-center text-slate-400 max-w-2xl mx-auto">Analyze a trading strategy using historical stock data.
            Adjust the parameters below to test different scenarios.</p>

        <div class="space-y-4">
            <h2 class="text-xl font-bold text-slate-200">Backtest Logic</h2>
            <ul class="list-disc list-inside space-y-2 text-sm text-slate-400">
                <li>
                    <span class="font-semibold text-slate-200">Entry Rule:</span> Buy when the stock's closing price is
                    supported by the SMA for a configurable number of days.
                </li>
                <li>
                    <span class="font-semibold text-slate-200">Exit Rule (Stop-Loss):</span> Sell when the stock's
                    closing price is under the SMA for a configurable number of consecutive days.
                </li>
                
            </ul>
        </div>

        <div id="backtestForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="col-span-full space-y-1">
                <label for="apiKey" class="block text-sm font-medium text-slate-300">API Key <span
                        class="text-xs text-red-400 font-normal">(Please provide your own key as the default is a
                        placeholder)</span></label>
                <input type="text" id="apiKey" value=""
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    placeholder="Enter your API key here" required>
            </div>
            <div class="col-span-full grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div><label for="ticker1" class="block text-sm font-medium text-slate-300">Ticker 1</label><input type="text" id="ticker1" value="AAPL" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker2" class="block text-sm font-medium text-slate-300">Ticker 2</label><input type="text" id="ticker2" value="GOOGL" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker3" class="block text-sm font-medium text-slate-300">Ticker 3</label><input type="text" id="ticker3" value="MSFT" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker4" class="block text-sm font-medium text-slate-300">Ticker 4</label><input type="text" id="ticker4" value="AMZN" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker5" class="block text-sm font-medium text-slate-300">Ticker 5</label><input type="text" id="ticker5" value="NVDA" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker6" class="block text-sm font-medium text-slate-300">Ticker 6</label><input type="text" id="ticker6" value="META" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
                <div><label for="ticker7" class="block text-sm font-medium text-slate-300">Ticker 7</label><input type="text" id="ticker7" value="TSLA" class="ticker-input w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"></div>
            </div>
            <div class="space-y-1">
                <label for="startDate" class="block text-sm font-medium text-slate-300">Start Date</label>
                <input type="date" id="startDate"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    required>
            </div>
            <div class="space-y-1">
                <label for="endDate" class="block text-sm font-medium text-slate-300">End Date</label>
                <input type="date" id="endDate"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    required>
            </div>
            <div class="space-y-1">
                <label for="investmentAmount" class="block text-sm font-medium text-slate-300">Initial Capital ($)</label>
                <input type="number" id="investmentAmount" value="100"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="rsiOversold" class="block text-sm font-medium text-slate-300">RSI Oversold Level</label>
                <input type="number" id="rsiOversold" value="40"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1" max="100">
            </div>
            <div class="space-y-1">
                <label for="rsiOverbought" class="block text-sm font-medium text-slate-300">RSI Overbought Level</label>
                <input type="number" id="rsiOverbought" value="70"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1" max="100">
            </div>
            <div class="space-y-1">
                <label for="smaPeriod" class="block text-sm font-medium text-slate-300">SMA Period (days)</label>
                <input type="number" id="smaPeriod" value="200"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="daysAboveSMA" class="block text-sm font-medium text-slate-300">Days Above SMA (Entry)</label>
                <input type="number" id="daysAboveSMA" value="2"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="daysUnderSMA" class="block text-sm font-medium text-slate-300">Days Under SMA (Exit)</label>
                <input type="number" id="daysUnderSMA" value="2"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="rsPeriod" class="block text-sm font-medium text-slate-300">RS Period (days)</label>
                <input type="number" id="rsPeriod" value="90"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="bbPeriod" class="block text-sm font-medium text-slate-300">Bollinger Band Period
                    (days)</label>
                <input type="number" id="bbPeriod" value="21"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="space-y-1">
                <label for="stdDev" class="block text-sm font-medium text-slate-300">Std Dev</label>
                <input type="number" id="stdDev" value="2"
                    class="w-full rounded-md border-0 bg-slate-800/50 text-white shadow-sm ring-1 ring-inset ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-blue-500 p-2 text-sm"
                    min="1">
            </div>
            <div class="col-span-full">
                <button id="runBacktestButton" type="button"
                    class="w-full rounded-md bg-blue-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
                    Run Backtest
                </button>
            </div>
        </div>

        <div id="loading" class="hidden flex justify-center items-center py-8">
            <div id="loading-spinner" class="w-12 h-12 border-4 border-solid rounded-full border-transparent"></div>
        </div>

        <div id="results" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 text-center">
                <div class="rounded-md bg-slate-800/50 p-4 shadow-md">
                    <p class="text-xl font-bold" id="total-return">-</p>
                    <p class="text-xs text-slate-400">Total Return</p>
                </div>
                <div class="rounded-md bg-slate-800/50 p-4 shadow-md">
                    <p class="text-xl font-bold" id="win-rate">-</p>
                    <p class="text-xs text-slate-400">Winning Trades</p>
                </div>
                <div class="rounded-md bg-slate-800/50 p-4 shadow-md">
                    <p class="text-xl font-bold" id="total-trades">-</p>
                    <p class="text-xs text-slate-400">Total Trades</p>
                </div>
            </div>

           

            <div class="mt-8 rounded-md bg-slate-800/50 p-4 shadow-md overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 text-center">Trade Log</h2>
                <table class="min-w-full divide-y divide-slate-700">
                    <thead>
                        <tr class="text-xs font-medium text-slate-300 uppercase tracking-wider">
                            <th class="px-2 py-3 text-left">Ticker</th>
                            <th class="px-2 py-3 text-left">Entry Date</th>
                            <th class="px-2 py-3 text-left">Idle Days</th>
                            <th class="px-2 py-3 text-left">Entry Price</th>
                            <th class="px-2 py-3 text-left">Entry Amount ($)</th>
                            <th class="px-2 py-3 text-left">Exit Date</th>
                            <th class="px-2 py-3 text-left">Exit Price</th>
                            <th class="px-2 py-3 text-left">Exit Amount ($)</th>
                            <th class="px-2 py-3 text-left">Hold Days</th>
                            <th class="px-2 py-3 text-left">Result ($)</th>
                            <th class="px-2 py-3 text-left">Result (%)</th>
                        </tr>
                    </thead>
                    <tbody id="tradeLog" class="divide-y divide-slate-700">
                        <!-- Trade log will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="rounded-md bg-slate-800/50 p-4 shadow-md">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const runBacktestButton = document.getElementById('runBacktestButton');
        const apiKeyInput = document.getElementById('apiKey');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const investmentAmountInput = document.getElementById('investmentAmount');
        const rsiOversoldInput = document.getElementById('rsiOversold');
        const rsiOverboughtInput = document.getElementById('rsiOverbought');
        const smaPeriodInput = document.getElementById('smaPeriod');
        const daysAboveSMAInput = document.getElementById('daysAboveSMA');
        const daysUnderSMAInput = document.getElementById('daysUnderSMA');
        const rsPeriodInput = document.getElementById('rsPeriod');
        const bbPeriodInput = document.getElementById('bbPeriod');
        const stdDevInput = document.getElementById('stdDev');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const totalReturnEl = document.getElementById('total-return');
        const winRateEl = document.getElementById('win-rate');
        const totalTradesEl = document.getElementById('total-trades');
        const tradeLogBody = document.getElementById('tradeLog');

        let myChart = null;

        document.addEventListener('DOMContentLoaded', (event) => {
            const savedApiKey = localStorage.getItem('apiKey');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        });

        // Set default dates
        startDateInput.value = '2022-01-01';
        endDateInput.value = '2025-01-01';

        // Function to handle fetching historical data in one call
        const fetchHistoricalData = async (ticker, startDate, endDate, apiKey) => {
            console.log(`API Fetch URL: https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${ticker}&from=${startDate}&to=${endDate}&apikey=${apiKey}`);
            const url = `https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${ticker}&from=${startDate}&to=${endDate}&apikey=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('The API key you provided is invalid. Please check your key or consider using a different API service.');
                }
                if (response.status === 429) {
                    throw new Error('API Request Limit Exceeded. Please try again later.');
                }
                throw new Error(`Failed to fetch data. Status: ${response.status} ${response.statusText}`);
            }

            const apiData = await response.json();
            console.log("API Response Data:", apiData[0]);
            if (apiData && apiData.length > 0) {
                // Data will be in this format 
                /**
                 * [
                    {
                        "symbol": "AAPL",
                        "date": "2024-12-31",
                        "open": 252.44,
                        "high": 253.28,
                        "low": 249.43,
                        "close": 250.42,
                        "volume": 39480718,
                        "change": -2.02,
                        "changePercent": -0.80019,
                        "vwap": 251.3925
                    }, ... ]
                 * 
                 * 
                 * */
                return apiData;
            } else {
                throw new Error('No historical data found for this ticker and date range. The API may have limitations on data or your key may not support the date range. Please try another ticker or a shorter date range.');
            }
        };

        // Calculation of indicators (SMA, RSI, Bollinger Bands)
        const calculateIndicators = (data, smaPeriod, bbPeriod, stdDevMultiplier, rsPeriod) => {
            let gains = [];
            let losses = [];
            let avgGain = 0;
            let avgLoss = 0;

            const newData = data.map((d, i) => {
                // SMA Calculation
                const sma = i >= smaPeriod - 1 ?
                    data.slice(i - smaPeriod + 1, i + 1).reduce((sum, item) => sum + item.close, 0) / smaPeriod :
                    null;

                // Bollinger Band Calculation
                let upperBand = null;
                let lowerBand = null;
                if (i >= bbPeriod - 1) {
                    const closes = data.slice(i - bbPeriod + 1, i + 1).map(item => item.close);
                    const mean = closes.reduce((sum, val) => sum + val, 0) / bbPeriod;
                    const stdDev = Math.sqrt(closes.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / bbPeriod);
                    upperBand = mean + (stdDev * stdDevMultiplier);
                    lowerBand = mean - (stdDev * stdDevMultiplier);
                }

                // RSI Calculation
                let rsi = null;
                if (i > 0) {
                    const diff = d.close - data[i - 1].close;
                    const gain = diff > 0 ? diff : 0;
                    const loss = diff < 0 ? -diff : 0;

                    if (i < 14) {
                        gains.push(gain);
                        losses.push(loss);
                    } else if (i === 14) {
                        avgGain = gains.reduce((a, b) => a + b) / 14;
                        avgLoss = losses.reduce((a, b) => a + b) / 14;
                    } else {
                        avgGain = ((avgGain * 13) + gain) / 14;
                        avgLoss = ((avgLoss * 13) + loss) / 14;
                    }

                    if (avgLoss !== 0) {
                        const rs = avgGain / avgLoss;
                        rsi = 100 - (100 / (1 + rs));
                    } else if (avgGain !== 0) {
                        rsi = 100;
                    }
                }

                // Relative Strength Calculation
                let relativeStrength = null;
                if (i >= rsPeriod) {
                    const pastPrice = data[i - rsPeriod].close;
                    if (pastPrice > 0) {
                        relativeStrength = ((d.close - pastPrice) / pastPrice) * 100;
                    }
                }

                return {
                    ...d,
                    sma,
                    rsi,
                    relativeStrength,
                    upperBand,
                    lowerBand
                };
            });
            return newData;
        };

        // Backtesting Strategy Logic
        const runStrategy = (allData, masterDateList, tickers, investmentAmount, daysAboveSMAForEntry, daysUnderSMAForExit) => {
            let position = null;
            let trades = [];
            let currentCapital = investmentAmount;

            const daysAboveSMA = {};
            const daysUnderSMA = {};
            tickers.forEach(t => {
                daysAboveSMA[t] = 0;
                daysUnderSMA[t] = 0;
            });

            console.log("Running strategy...");
            console.log(`Initial Capital: $${currentCapital.toFixed(2)}`);

            for (const date of masterDateList) {
                // First, update all counters for all tickers for the current date
                tickers.forEach(ticker => {
                    const day = allData[ticker]?.find(d => d.date === date);
                    if (day && day.sma) {
                        if (day.close >= day.sma) {
                            daysAboveSMA[ticker]++;
                            daysUnderSMA[ticker] = 0;
                        } else {
                            daysUnderSMA[ticker]++;
                            daysAboveSMA[ticker] = 0;
                        }
                    }
                });

                // Now, handle logic
                if (position) { // IN A TRADE
                    const heldTicker = position.ticker;
                    const day = allData[heldTicker]?.find(d => d.date === date);
                    if (day) {
                        const stopLoss = daysUnderSMA[heldTicker] >= daysUnderSMAForExit;
                        if (stopLoss || date === masterDateList[masterDateList.length - 1]) {
                            const trade = trades[position.tradeLogIndex];
                            trade.exitDate = day.date;
                            trade.exitPrice = day.close;

                            const result = (trade.exitPrice - trade.entryPrice) * trade.shares;
                            trade.result = result;
                            trade.resultPercentage = ((trade.exitPrice - trade.entryPrice) / trade.entryPrice) * 100;
                            currentCapital += result;
                            trade.exitAmount = currentCapital;

                            console.log(`%cTrade Exited ${heldTicker} on ${day.date} at ${day.close}. P/L: ${result.toFixed(2)}. New Capital: ${currentCapital.toFixed(2)}`, 'color: red');
                            position = null;
                        }
                    }
                } else { // IDLE, LOOKING FOR A TRADE
                    const candidates = [];
                    tickers.forEach(ticker => {
                        const day = allData[ticker]?.find(d => d.date === date);
                        if (day && day.sma && day.relativeStrength) {
                            if (daysAboveSMA[ticker] >= daysAboveSMAForEntry) {
                                candidates.push({ ticker, rs: day.relativeStrength, dayData: day });
                            }
                        }
                    });

                    if (candidates.length > 0) {
                        candidates.sort((a, b) => b.rs - a.rs); // Sort by RS descending
                        const bestCandidate = candidates[0];
                        const { ticker, dayData } = bestCandidate;

                        const shares = currentCapital / dayData.close;
                        position = {
                            ticker: ticker,
                            entryDate: dayData.date,
                            entryPrice: dayData.close,
                            shares: shares,
                            tradeLogIndex: trades.length
                        };
                        trades.push({
                            ticker: ticker,
                            entryDate: dayData.date,
                            entryPrice: dayData.close,
                            entryAmount: currentCapital,
                            exitAmount: null,
                            shares: shares,
                            exitDate: null,
                            exitPrice: null,
                            result: null,
                            resultPercentage: null
                        });
                        console.log(`%cTrade Entered ${ticker} on ${dayData.date} at ${dayData.close}`, 'color: green');
                        // Reset counters after entry
                        tickers.forEach(t => { daysAboveSMA[t] = 0; daysUnderSMA[t] = 0; });
                    }
                }
            }

            console.log("Strategy run complete.");

            return trades;
        };

        const displayResults = (trades) => {
            const winningTrades = trades.filter(t => t.result !== null && t.result > 0);
            const totalReturn = trades.reduce((sum, t) => sum + (t.result || 0), 0);
            const winRate = trades.length > 0 ? (winningTrades.length / trades.length) * 100 : 0;
            const finalPnlColor = totalReturn >= 0 ? 'text-green-500' : 'text-red-500';

            totalReturnEl.innerHTML = `<span class="${finalPnlColor}">$${totalReturn.toFixed(2)}</span>`;
            winRateEl.textContent = `${winRate.toFixed(2)}% (${winningTrades.length}/${trades.length})`;
            totalTradesEl.textContent = trades.length;

            tradeLogBody.innerHTML = '';
            trades.forEach((trade, index) => {
                const row = document.createElement('tr');
                const pnlColor = (trade.result ?? 0) >= 0 ? 'text-green-500' : 'text-red-500';

                // Calculate Idle Days
                let idleDaysText = 'N/A';
                if (index > 0) {
                    const previousTrade = trades[index - 1];
                    if (previousTrade.exitDate) {
                        const currentEntry = new Date(trade.entryDate);
                        const previousExit = new Date(previousTrade.exitDate);
                        const diffTime = currentEntry - previousExit;
                        idleDaysText = Math.round(diffTime / (1000 * 60 * 60 * 24));
                    }
                } else {
                    const simStartDate = new Date(startDateInput.value);
                    const firstEntryDate = new Date(trade.entryDate);
                    const diffTime = firstEntryDate - simStartDate;
                    idleDaysText = Math.round(diffTime / (1000 * 60 * 60 * 24));
                }

                // Calculate Hold Days
                let holdDaysText = 'N/A';
                if (trade.exitDate) {
                    const entry = new Date(trade.entryDate);
                    const exit = new Date(trade.exitDate);
                    const diffTime = exit - entry;
                    holdDaysText = Math.round(diffTime / (1000 * 60 * 60 * 24));
                }

                row.innerHTML = `
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300 font-bold">${trade.ticker}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${trade.entryDate}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${idleDaysText}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">$${trade.entryPrice.toFixed(2)}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">$${trade.entryAmount.toFixed(2)}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${trade.exitDate ?? 'N/A'}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${trade.exitPrice ? '$' + trade.exitPrice.toFixed(2) : 'N/A'}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${trade.exitAmount ? '$' + trade.exitAmount.toFixed(2) : 'N/A'}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-slate-300">${holdDaysText}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm font-medium ${pnlColor}">${trade.result !== null ? '$' + trade.result.toFixed(2) : 'Open'}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm font-medium ${pnlColor}">${trade.resultPercentage !== null ? trade.resultPercentage.toFixed(2) + '%' : 'Open'}</td>
        `;
                tradeLogBody.appendChild(row);
            });

            resultsDiv.classList.remove('hidden');
        };

        // Main backtesting function
        const runBacktest = async () => {
            console.log(`Console URL: ${window.location.href}`);
            const API_KEY = apiKeyInput.value.trim();
            localStorage.setItem('apiKey', API_KEY);


            // Clear previous results
            resultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            tradeLogBody.innerHTML = '';
            if (myChart) {
                myChart.destroy();
            }

            try {
                const tickerInputs = document.querySelectorAll('.ticker-input');
                const tickers = Array.from(tickerInputs).map(input => input.value.toUpperCase().trim()).filter(t => t);

                if (tickers.length === 0) {
                    throw new Error('Please enter at least one ticker.');
                }

                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const investmentAmount = parseFloat(investmentAmountInput.value);
                const smaPeriod = parseInt(smaPeriodInput.value);
                const daysAboveSMA = parseInt(daysAboveSMAInput.value);
                const daysUnderSMA = parseInt(daysUnderSMAInput.value);
                const rsPeriod = parseInt(rsPeriodInput.value);
                const bbPeriod = parseInt(bbPeriodInput.value);
                const stdDevMultiplier = parseFloat(stdDevInput.value);

                if (!API_KEY) {
                    throw new Error('Please enter a valid API key in the input field above.');
                }
                
                const allData = {};
                const dataPromises = tickers.map(ticker => fetchHistoricalData(ticker, startDate, endDate, API_KEY));
                const results = await Promise.all(dataPromises);

                results.forEach((data, index) => {
                    const ticker = tickers[index];
                    if (data && data.length > 0) {
                        const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
                        allData[ticker] = calculateIndicators(sortedData, smaPeriod, bbPeriod, stdDevMultiplier, rsPeriod);
                    } else {
                        console.warn(`No data returned for ticker: ${ticker}`);
                    }
                });

                if (Object.keys(allData).length === 0) {
                    throw new Error('Could not fetch data for any of the provided tickers.');
                }

                // Create a master list of all unique trading days across all tickers
                const allDates = new Set();
                Object.values(allData).forEach(data => {
                    data.forEach(day => allDates.add(day.date));
                });
                const masterDateList = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));

                // Run the backtest strategy
                const trades = runStrategy(allData, masterDateList, Object.keys(allData), investmentAmount, daysAboveSMA, daysUnderSMA);

                // Display the results
                displayResults(trades);

            } catch (error) {
                console.error("Backtesting failed:", error);
                // Use a custom message box instead of alert()
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                                            <div class="bg-gray-800 rounded-lg p-6 max-w-sm text-center shadow-lg border border-gray-700">
                                                <p class="text-lg font-semibold text-red-400 mb-4">Error</p>
                                                <p class="text-sm text-white mb-6">${error.message}</p>
                                                <button class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded" onclick="this.parentElement.parentElement.remove()">Close</button>
                                            </div>
                                        </div>`;
                document.body.appendChild(messageBox);

                resultsDiv.classList.add('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        };

        runBacktestButton.addEventListener('click', runBacktest);
    </script>
</body>

</html>