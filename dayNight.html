<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Overnight Trading Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Simple Overnight Trading Simulator</h1>
            <p class="mt-2 text-md text-gray-600">Strategy: Buy at Close, Sell at Next Day's Open</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto">
            <!-- Controls -->
            <div class="flex flex-col sm:flex-row items-start justify-between gap-4 border-b border-gray-200 pb-6">
                <div class="flex-grow space-y-3">
                    <div class="space-y-3 pt-2">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="flex items-center gap-2">
                                <label for="ticker-input" class="font-semibold text-gray-800 whitespace-nowrap">Ticker:</label>
                                <input type="text" id="ticker-input" value="SPY" placeholder="e.g., SPY, QQQ" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full uppercase">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="api-key" class="font-semibold text-gray-800 whitespace-nowrap">API Key:</label>
                                <input type="password" value="PF9NLS6UHJ5VH89X" id="api-key" placeholder="Get a free key from Alpha Vantage" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="investment-amount" class="font-semibold text-gray-800 whitespace-nowrap">Initial Capital ($):</label>
                                <input type="number" id="investment-amount" value="1000" min="1" step="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                             <div class="flex items-center gap-2 justify-start sm:justify-end pt-2">
                                <input type="checkbox" id="compounding-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="compounding-checkbox" class="font-semibold text-gray-800">Enable Compounding</label>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mt-3">
                            <div class="flex items-center gap-2">
                                <label for="start-date" class="font-semibold text-gray-800">From:</label>
                                <input type="date" id="start-date" value="2022-01-01" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="end-date" class="font-semibold text-gray-800">To:</label>
                                <input type="date" id="end-date" value="2024-12-31" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>
                    </div>
                </div>
                <button id="run-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 mt-4 sm:mt-0 self-end disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Run Simulation
                </button>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"></div>

            <!-- Results -->
            <div id="results-container" class="mt-6 hidden">
                <!-- Loader -->
                <div id="loader" class="flex flex-col justify-center items-center py-10">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
                    <p id="loader-text" class="mt-4 text-gray-600">Fetching historical data...</p>
                </div>
                
                <!-- Summary -->
                <div id="summary" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Simulation Results</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Initial Capital</p><p id="initial-capital" class="text-xl font-semibold text-gray-700"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Final Capital</p><p id="final-capital" class="text-xl font-semibold"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Total Return</p><p id="total-return" class="text-xl font-semibold"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Win Rate</p><p id="win-rate" class="text-xl font-semibold text-gray-700"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Completed Trades</p><p id="total-trades" class="text-xl font-semibold text-gray-700"></p></div>
                    </div>
                </div>

                <!-- Trade Log -->
                <div id="trade-log-container" class="hidden mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Trade Log</h3>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full leading-normal">
                            <thead id="trade-log-head">
                                <!-- Header generated by JS -->
                            </thead>
                            <tbody id="trade-log-body" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Disclaimer: This is a financial simulation for educational purposes only. It does not constitute investment advice. Past performance is not indicative of future results.</p>
        </footer>
    </div>

    <script>
        // --- API & Data Fetching ---
        async function fetchDailyData(ticker, apiKey, onProgress) {
            onProgress('Fetching daily historical data...');
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${ticker}&outputsize=full&apikey=${apiKey}&datatype=csv`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            const csvText = await response.text();
            if (!csvText.startsWith('timestamp,open,high,low,close,adjusted_close')) {
                throw new Error("Invalid daily data from API. Check key or usage limits.");
            }

            const dailyData = {};
            const rows = csvText.trim().split('\n').slice(1);
            rows.forEach(row => {
                const [date, open, high, low, close, adjusted_close] = row.split(',');
                if(date && open && adjusted_close) {
                    dailyData[date] = {
                        open: parseFloat(open),
                        close: parseFloat(adjusted_close) // Use adjusted close for buys to account for dividends/splits
                    };
                }
            });
            return dailyData;
        }

        // --- Backtesting & Display ---
        function runBacktest(dailyData, initialCapital, startDate, endDate, useCompounding) {
            const trades = [];
            const sortedDates = Object.keys(dailyData).sort();
            let currentCapital = initialCapital;
            
            for (let i = 0; i < sortedDates.length - 1; i++) {
                const buyDate = sortedDates[i];
                const sellDate = sortedDates[i+1]; // Sell on the next available day

                if (buyDate < startDate || sellDate > endDate) {
                    continue;
                }

                const buyPrice = dailyData[buyDate].close;
                const sellPrice = dailyData[sellDate].open;

                if (buyPrice && sellPrice) {
                    const investment = useCompounding ? currentCapital : initialCapital;
                    const shares = investment / buyPrice;
                    const profit = (sellPrice - buyPrice) * shares;
                    
                    const tradeData = {
                        buyDate,
                        buyPrice,
                        sellDate,
                        sellPrice,
                        profit,
                        capitalBefore: currentCapital
                    };
                    
                    currentCapital += profit;
                    tradeData.capitalAfter = currentCapital;
                    trades.push(tradeData);
                }
            }
            return { trades, finalCapital: currentCapital };
        }

        function displayResults(results, initialCapital, useCompounding) {
            const { trades, finalCapital } = results;
            const totalProfit = finalCapital - initialCapital;
            const totalReturn = ((finalCapital - initialCapital) / initialCapital * 100);
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.profit > 0).length;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 'N/A';

            document.getElementById('initial-capital').textContent = `$${initialCapital.toFixed(2)}`;
            document.getElementById('final-capital').textContent = `$${finalCapital.toFixed(2)}`;
            document.getElementById('final-capital').className = `text-xl font-semibold ${finalCapital >= initialCapital ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('total-return').textContent = `${totalReturn.toFixed(2)}%`;
            document.getElementById('total-return').className = `text-xl font-semibold ${totalReturn >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('total-trades').textContent = totalTrades;

            const tradeLogHead = document.getElementById('trade-log-head');
            const tradeLogBody = document.getElementById('trade-log-body');
            tradeLogBody.innerHTML = '';
            
            if (useCompounding) {
                tradeLogHead.innerHTML = `
                    <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        <th class="px-5 py-3">#</th><th class="px-5 py-3">Buy Date</th><th class="px-5 py-3">Capital Before</th>
                        <th class="px-5 py-3">Sell Date</th><th class="px-5 py-3">P/L ($)</th><th class="px-5 py-3">Capital After</th>
                    </tr>`;
                trades.forEach((trade, index) => {
                    const profitClass = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-5 py-4">${index + 1}</td>
                            <td class="px-5 py-4">${trade.buyDate}</td>
                            <td class="px-5 py-4">$${trade.capitalBefore.toFixed(2)}</td>
                            <td class="px-5 py-4">${trade.sellDate}</td>
                            <td class="px-5 py-4 ${profitClass} font-medium">$${trade.profit.toFixed(2)}</td>
                            <td class="px-5 py-4">$${trade.capitalAfter.toFixed(2)}</td>
                        </tr>`;
                    tradeLogBody.innerHTML += row;
                });
            } else {
                 tradeLogHead.innerHTML = `
                    <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        <th class="px-5 py-3">#</th><th class="px-5 py-3">Buy Date (Close)</th><th class="px-5 py-3">Buy Price</th>
                        <th class="px-5 py-3">Sell Date (Open)</th><th class="px-5 py-3">Sell Price</th><th class="px-5 py-3">P/L ($)</th>
                    </tr>`;
                trades.forEach((trade, index) => {
                    const profitClass = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-5 py-4">${index + 1}</td>
                            <td class="px-5 py-4">${trade.buyDate}</td>
                            <td class="px-5 py-4">$${trade.buyPrice.toFixed(2)}</td>
                            <td class="px-5 py-4">${trade.sellDate}</td>
                            <td class="px-5 py-4">$${trade.sellPrice.toFixed(2)}</td>
                            <td class="px-5 py-4 ${profitClass} font-medium">$${trade.profit.toFixed(2)}</td>
                        </tr>`;
                    tradeLogBody.innerHTML += row;
                });
            }
        }

        // --- Main App Logic ---
        async function runSimulation() {
            const runButton = document.getElementById('run-button');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const resultsContainer = document.getElementById('results-container');
            const summary = document.getElementById('summary');
            const tradeLogContainer = document.getElementById('trade-log-container');
            const errorMessage = document.getElementById('error-message');
            
            runButton.disabled = true;
            errorMessage.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            summary.classList.add('hidden');
            tradeLogContainer.classList.add('hidden');
            loader.style.display = 'flex';
            loaderText.textContent = 'Preparing simulation...';

            try {
                // Get parameters
                const ticker = document.getElementById('ticker-input').value.toUpperCase();
                const apiKey = document.getElementById('api-key').value;
                const investmentAmount = parseFloat(document.getElementById('investment-amount').value);
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const useCompounding = document.getElementById('compounding-checkbox').checked;

                // Validation
                if (!ticker || !apiKey || !startDate || !endDate) throw new Error("Please fill all required fields.");
                if (isNaN(investmentAmount) || investmentAmount <= 0) throw new Error("Please enter a valid, positive investment amount.");
                if (new Date(startDate) >= new Date(endDate)) throw new Error("The 'From' date must be before the 'To' date.");

                // Fetch data
                const dailyData = await fetchDailyData(ticker, apiKey, (progress) => loaderText.textContent = progress);
                
                // Run backtest
                loaderText.textContent = 'Running backtest...';
                const backtestResults = runBacktest(dailyData, investmentAmount, startDate, endDate, useCompounding);
                
                // Display results
                displayResults(backtestResults, investmentAmount, useCompounding);
                summary.classList.remove('hidden');
                tradeLogContainer.classList.remove('hidden');

            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
                runButton.disabled = false;
            }
        }
        
        document.getElementById('run-button').addEventListener('click', runSimulation);
    </script>
</body>
</html>
