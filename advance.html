<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Stock Trading Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Advanced Stock Trading Simulator</h1>
            <p class="mt-2 text-md text-gray-600">Using Technical Indicators to find Trade Opportunities</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto">
            <!-- Strategy Selector -->
            <div class="mb-6">
                <label for="strategy-select" class="block mb-2 text-sm font-bold text-gray-900">Select Trading Strategy:</label>
                <select id="strategy-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="hybrid">SMA Filter + RSI Entry (Recommended)</option>
                    <option value="bollinger">Bollinger Bands</option>
                    <option value="rsi">RSI Only</option>
                    <option value="sma">SMA Crossover Only</option>
                </select>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row items-start justify-between gap-4 border-b border-gray-200 pb-6">
                <div class="flex-grow space-y-3">
                    <p id="strategy-description" class="p-3 bg-blue-50 rounded-lg text-blue-800 border border-blue-200"></p>
                    <div class="space-y-3 pt-2">
                         <div class="flex items-center gap-2">
                            <label for="ticker-input" class="font-semibold text-gray-800 whitespace-nowrap">Ticker:</label>
                            <input type="text" id="ticker-input" value="VOOG" placeholder="e.g., AAPL, MSFT" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full uppercase">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="api-key" class="font-semibold text-gray-800 whitespace-nowrap">API Key:</label>
                            <input type="password" value="PF9NLS6UHJ5VH89X" id="api-key" placeholder="Get a free key from Alpha Vantage" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                        </div>
                        
                        <!-- Strategy-specific controls -->
                        <div id="bollinger-controls" class="hidden grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="flex items-center gap-2">
                                <label for="bollinger-period" class="font-semibold text-gray-800 whitespace-nowrap">Period:</label>
                                <input type="number" id="bollinger-period" value="20" min="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="bollinger-stddev" class="font-semibold text-gray-800 whitespace-nowrap">Std. Dev:</label>
                                <input type="number" id="bollinger-stddev" value="2" min="1" step="0.1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>
                        <div id="sma-controls" class="hidden grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="flex items-center gap-2">
                                <label for="fast-sma" class="font-semibold text-gray-800 whitespace-nowrap">Fast SMA:</label>
                                <input type="number" id="fast-sma" value="50" min="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="slow-sma" class="font-semibold text-gray-800 whitespace-nowrap">Slow SMA:</label>
                                <input type="number" id="slow-sma" value="200" min="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>
                        <div id="rsi-controls" class="hidden grid-cols-1 sm:grid-cols-2 gap-3">
                             <div class="flex items-center gap-2">
                                <label for="rsi-period" class="font-semibold text-gray-800 whitespace-nowrap">RSI Period:</label>
                                <input type="number" id="rsi-period" value="14" min="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="rsi-oversold" class="font-semibold text-gray-800 whitespace-nowrap">RSI Oversold:</label>
                                <input type="number" id="rsi-oversold" value="100" min="1" max="100" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>

                        <!-- General controls -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                            <div class="flex items-center gap-2">
                                <label for="investment-amount" class="font-semibold text-gray-800 whitespace-nowrap">Investment ($):</label>
                                <input type="number" id="investment-amount" value="100" min="1" step="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                             <div class="flex items-center gap-2">
                                <label for="profit-percent" class="font-semibold text-gray-800 whitespace-nowrap">Profit Target (%):</label>
                                <input type="number" id="profit-percent" value="2" min="0.1" step="0.1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                             <div class="flex items-center gap-2">
                                <label for="stop-loss-percent" class="font-semibold text-gray-800 whitespace-nowrap">Stop-Loss (%):</label>
                                <input type="number" id="stop-loss-percent" value="4" min="0.1" step="0.1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mt-3">
                            <div class="flex items-center gap-2">
                                <label for="start-date" class="font-semibold text-gray-800">From:</label>
                                <input type="date" id="start-date" value="2022-01-01" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="end-date" class="font-semibold text-gray-800">To:</label>
                                <input type="date" id="end-date" value="2024-12-31" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-full">
                            </div>
                        </div>
                    </div>
                </div>
                <button id="run-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 mt-4 sm:mt-0 self-end disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Run Simulation
                </button>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"></div>

            <!-- Results -->
            <div id="results-container" class="mt-6 hidden">
                <!-- Loader -->
                <div id="loader" class="flex flex-col justify-center items-center py-10">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
                    <p id="loader-text" class="mt-4 text-gray-600">Fetching historical data...</p>
                </div>
                
                <!-- Summary -->
                <div id="summary" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Simulation Results</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Total P/L</p><p id="total-profit" class="text-xl font-semibold"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Win Rate</p><p id="win-rate" class="text-xl font-semibold text-gray-700"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Completed Trades</p><p id="total-trades" class="text-xl font-semibold text-gray-700"></p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Avg. Hold Time</p><p id="avg-hold-time" class="text-xl font-semibold text-gray-700"></p></div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div id="chart-container" class="hidden mt-8">
                     <h3 class="text-xl font-bold mb-4 text-gray-800">Trade Visualization</h3>
                     <canvas id="trade-chart"></canvas>
                </div>

                <!-- Trade Log -->
                <div id="trade-log-container" class="hidden mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Trade Log</h3>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <th class="px-5 py-3">#</th><th class="px-5 py-3">Buy Date & Time</th><th class="px-5 py-3">Buy Price</th>
                                    <th class="px-5 py-3">Sell Date & Time</th><th class="px-5 py-3">Sell Price</th><th class="px-5 py-3">P/L ($)</th><th class="px-5 py-3">Hold Time</th>
                                </tr>
                            </thead>
                            <tbody id="trade-log-body" class="text-sm"></tbody>
                        </table>
                    </div>
                    <div id="final-position" class="hidden mt-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                        <p class="font-bold">Open Position</p>
                        <p id="final-position-text"></p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Disclaimer: This is a financial simulation for educational purposes only. It does not constitute investment advice. Past performance is not indicative of future results.</p>
        </footer>
    </div>

    <script>
        // --- IndexedDB Caching ---
        const DB_NAME = 'StockDataCacheAdvance';
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("IndexedDB error: " + request.error);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const storeNames = event.target.result.objectStoreNames;
                    if (!storeNames.contains('monthlyData')) event.target.result.createObjectStore('monthlyData');
                    if (!storeNames.contains('dailyData')) event.target.result.createObjectStore('dailyData');
                };
            });
        }

        function getCachedData(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { resolve(null); return; }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject("Error fetching from cache: " + request.error);
            });
        }

        function setCachedData(storeName, key, value) {
            return new Promise((resolve, reject) => {
                 if (!db) { resolve(); return; }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error saving to cache: " + request.error);
            });
        }

        // --- API & Data ---

        async function fetchDailyData(ticker, apiKey, onProgress) {
            onProgress('Fetching daily data for indicator calculations...');
            const cacheKey = `${ticker}_daily`;
            let csvText = await getCachedData('dailyData', cacheKey);

            if (!csvText) {
                const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${ticker}&outputsize=full&apikey=${apiKey}&datatype=csv`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                csvText = await response.text();
                if (!csvText.startsWith('timestamp,open,high,low,close,adjusted_close')) {
                    throw new Error("Invalid daily data from API. Check key or usage limits.");
                }
                await setCachedData('dailyData', cacheKey, csvText);
            }

            const dailyPrices = {};
            const rows = csvText.trim().split('\n').slice(1);
            rows.forEach(row => {
                const [date, open, high, low, close, adjusted_close] = row.split(',');
                if(date && adjusted_close) dailyPrices[date] = parseFloat(adjusted_close);
            });
            return dailyPrices;
        }

        async function fetchIntradayData(ticker, startDate, endDate, apiKey, onProgress) {
            const allData = {};
            let currentDate = new Date(startDate);
            const finalDate = new Date(endDate);
            
            const monthsToFetch = [];
            while(currentDate <= finalDate) {
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const monthStr = `${year}-${month}`;
                if (!monthsToFetch.includes(monthStr)) monthsToFetch.push(monthStr);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            for (let i = 0; i < monthsToFetch.length; i++) {
                const month = monthsToFetch[i];
                const cacheKey = `${ticker}_${month}`;
                let csvText = await getCachedData('monthlyData', cacheKey);

                if (csvText) {
                    onProgress(`Loading ${month} from cache...`);
                    await new Promise(resolve => setTimeout(resolve, 50));
                } else {
                    onProgress(`Fetching intraday data for ${month} (${i+1} of ${monthsToFetch.length})...`);
                    const url = `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${ticker}&interval=1min&month=${month}&outputsize=full&apikey=${apiKey}&datatype=csv`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    
                    csvText = await response.text();
                    if (!csvText.startsWith('timestamp,open,high,low,close,volume')) {
                         throw new Error("Invalid intraday data from API. Check key or usage limits.");
                    }
                    await setCachedData('monthlyData', cacheKey, csvText);

                    if (i < monthsToFetch.length - 1) await new Promise(resolve => setTimeout(resolve, 13000));
                }

                const rows = csvText.trim().split('\n').slice(1);
                rows.forEach(row => {
                    if (row) {
                        const [timestamp, open, high, low, close, volume] = row.split(',');
                        if (timestamp && timestamp.includes(' ')) {
                            const [date, timeWithSeconds] = timestamp.split(' ');
                            const time = timeWithSeconds.substring(0, 5);
                            if (!allData[date]) allData[date] = [];
                            allData[date].push({ time: time, price: parseFloat(close) });
                        }
                    }
                });
            }
            return allData;
        }

        // --- Indicator Calculations ---

        function calculateSMAs(dailyPrices, fastPeriod, slowPeriod) {
            const dates = Object.keys(dailyPrices).sort();
            const smas = {};
            for (let i = slowPeriod - 1; i < dates.length; i++) {
                const currentDate = dates[i];
                const fastSlice = dates.slice(i - fastPeriod + 1, i + 1);
                const slowSlice = dates.slice(i - slowPeriod + 1, i + 1);
                
                const fastSum = fastSlice.reduce((sum, date) => sum + dailyPrices[date], 0);
                const slowSum = slowSlice.reduce((sum, date) => sum + dailyPrices[date], 0);

                smas[currentDate] = {
                    fast: fastSum / fastPeriod,
                    slow: slowSum / slowPeriod
                };
            }
            return smas;
        }

        function calculateRSI(dailyPrices, period) {
            const dates = Object.keys(dailyPrices).sort();
            const rsiValues = {};
            let avgGain = 0, avgLoss = 0;

            for (let i = 1; i < dates.length; i++) {
                const priceDate = dates[i];
                const prevPriceDate = dates[i-1];
                if(!dailyPrices[priceDate] || !dailyPrices[prevPriceDate]) continue;

                const change = dailyPrices[priceDate] - dailyPrices[prevPriceDate];
                let gain = change > 0 ? change : 0;
                let loss = change < 0 ? -change : 0;

                if (i <= period) {
                    avgGain += gain;
                    avgLoss += loss;
                    if (i === period) {
                        avgGain /= period;
                        avgLoss /= period;
                    }
                } else {
                    avgGain = (avgGain * (period - 1) + gain) / period;
                    avgLoss = (avgLoss * (period - 1) + loss) / period;
                }

                if (i >= period) {
                    if (avgLoss === 0) {
                        rsiValues[priceDate] = 100;
                    } else {
                        const rs = avgGain / avgLoss;
                        rsiValues[priceDate] = 100 - (100 / (1 + rs));
                    }
                }
            }
            return rsiValues;
        }

        function calculateBollingerBands(dailyPrices, period, stdDev) {
            const dates = Object.keys(dailyPrices).sort();
            const bands = {};
            for (let i = period - 1; i < dates.length; i++) {
                const currentDate = dates[i];
                const slice = dates.slice(i - period + 1, i + 1).map(date => dailyPrices[date]);
                const sma = slice.reduce((sum, price) => sum + price, 0) / period;
                const variance = slice.reduce((sum, price) => sum + Math.pow(price - sma, 2), 0) / period;
                const deviation = Math.sqrt(variance);
                bands[currentDate] = {
                    middle: sma,
                    upper: sma + (stdDev * deviation),
                    lower: sma - (stdDev * deviation)
                };
            }
            return bands;
        }


        // --- Backtesting & Display ---

        function runBacktest(params) {
            const { strategy, intradayData, dailyIndicators, profitPercentage, stopLossPercentage, investmentAmount } = params;
            let portfolio = null;
            const trades = [];
            const sortedDates = Object.keys(intradayData).sort();
            const sellMultiplier = 1 + (profitPercentage / 100);
            
            for (const date of sortedDates) {
                const dayData = intradayData[date];
                if (!dayData) continue;
                
                let soldToday = false;
                
                // Check for sell conditions first
                if (portfolio) {
                    for (const candle of dayData) {
                        let sold = false;
                        if (candle.price >= portfolio.sellTargetPrice) {
                            trades.push({ ...portfolio, sellPrice: candle.price, sellDate: date, sellTime: candle.time, profit: (candle.price - portfolio.buyPrice) * portfolio.shares });
                            sold = true;
                        } else if (candle.price <= portfolio.stopLossPrice) {
                             trades.push({ ...portfolio, sellPrice: candle.price, sellDate: date, sellTime: candle.time, profit: (candle.price - portfolio.buyPrice) * portfolio.shares });
                             sold = true;
                        }

                        if(sold){
                            portfolio = null;
                            soldToday = true;
                            break; 
                        }
                    }
                }

                // If we sold today, or still have a position, don't look for a new one.
                if (soldToday || portfolio) continue;

                // Check for buy condition
                let dailyBuySignal = false;
                if (strategy === 'sma') {
                    const dailySma = dailyIndicators.smas ? dailyIndicators.smas[date] : undefined;
                    if (dailySma && dailySma.fast > dailySma.slow) dailyBuySignal = true;
                } else if (strategy === 'rsi') {
                    const dailyRsi = dailyIndicators.rsi ? dailyIndicators.rsi[date] : undefined;
                    if (dailyRsi && dailyRsi < params.rsiOversold) dailyBuySignal = true;
                } else if (strategy === 'hybrid') {
                    const dailySma = dailyIndicators.smas ? dailyIndicators.smas[date] : undefined;
                    const dailyRsi = dailyIndicators.rsi ? dailyIndicators.rsi[date] : undefined;
                    if (dailySma && dailySma.fast > dailySma.slow && dailyRsi && dailyRsi < params.rsiOversold) dailyBuySignal = true;
                } else if (strategy === 'bollinger') {
                    if (dailyIndicators.bollinger && dailyIndicators.bollinger[date]) dailyBuySignal = true; // Signal is checked per candle
                }

                if (dailyBuySignal) {
                    for (const candle of dayData) {
                        let actualBuySignal = false;
                        if (strategy === 'bollinger') {
                            const dailyBoll = dailyIndicators.bollinger[date];
                            if (candle.price <= dailyBoll.lower) {
                                actualBuySignal = true;
                            }
                        } else {
                            // For other strategies, the daily signal is enough for a one-time check
                            actualBuySignal = true;
                        }

                        if (actualBuySignal) {
                            const buyPrice = candle.price;
                            portfolio = {
                                buyPrice: buyPrice,
                                buyDate: date,
                                buyTime: candle.time,
                                shares: investmentAmount / buyPrice,
                                sellTargetPrice: buyPrice * sellMultiplier,
                                stopLossPrice: buyPrice * (1 - stopLossPercentage / 100)
                            };
                            break; // Exit the loop for this day after buying
                        }
                    }
                }
            }
            return { trades, finalOpenPosition: portfolio };
        }

        let tradeChart = null; // Keep a reference to the chart instance

        function displayChart(trades, intradayData) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.classList.remove('hidden');

            const ctx = document.getElementById('trade-chart').getContext('2d');
            
            if (tradeChart) {
                tradeChart.destroy(); // Destroy previous chart instance if it exists
            }

            const priceData = [];
            Object.keys(intradayData).sort().forEach(date => {
                intradayData[date].forEach(candle => {
                    priceData.push({
                        x: new Date(`${date}T${candle.time}`),
                        y: candle.price
                    });
                });
            });

            const buyPoints = trades.map(trade => ({
                x: new Date(`${trade.buyDate}T${trade.buyTime}`),
                y: trade.buyPrice
            }));

            const sellPoints = trades.map(trade => ({
                x: new Date(`${trade.sellDate}T${trade.sellTime}`),
                y: trade.sellPrice
            }));


            tradeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Price',
                        data: priceData,
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    }, {
                        label: 'Buy',
                        data: buyPoints,
                        backgroundColor: 'rgb(75, 192, 192)',
                        pointStyle: 'triangle',
                        radius: 7,
                        rotation: 0,
                        type: 'scatter'
                    }, {
                        label: 'Sell',
                        data: sellPoints,
                        backgroundColor: 'rgb(255, 99, 132)',
                        pointStyle: 'triangle',
                        radius: 7,
                        rotation: 180,
                        type: 'scatter'
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    responsive: true
                }
            });
        }


        function displayResults(results, intradayData) {
            const { trades, finalOpenPosition } = results;
            const totalProfit = trades.reduce((sum, trade) => sum + trade.profit, 0);
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.profit > 0).length;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 'N/A';

            let totalHoldMs = 0;
            trades.forEach(trade => {
                const buyDateTime = new Date(`${trade.buyDate}T${trade.buyTime}:00`);
                const sellDateTime = new Date(`${trade.sellDate}T${trade.sellTime}:00`);
                totalHoldMs += Math.abs(sellDateTime - buyDateTime);
            });
            
            let avgHoldTime = "N/A";
            if (totalTrades > 0) {
                 const avgMs = totalHoldMs / totalTrades;
                 const days = Math.floor(avgMs / (1000 * 60 * 60 * 24));
                 const hours = Math.floor((avgMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                 const minutes = Math.floor((avgMs % (1000 * 60 * 60)) / (1000 * 60));
                 if (days > 0) {
                     avgHoldTime = `${days}d ${hours}h`;
                 } else if (hours > 0) {
                     avgHoldTime = `${hours}h ${minutes}m`;
                 } else {
                     avgHoldTime = `${minutes}m`;
                 }
            }
            
            document.getElementById('total-profit').textContent = `$${totalProfit.toFixed(2)}`;
            document.getElementById('total-profit').className = `text-xl font-semibold ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('avg-hold-time').textContent = avgHoldTime;

            const tradeLogBody = document.getElementById('trade-log-body');
            tradeLogBody.innerHTML = '';
            trades.forEach((trade, index) => {
                const buyDateTime = new Date(`${trade.buyDate}T${trade.buyTime}:00`);
                const sellDateTime = new Date(`${trade.sellDate}T${trade.sellTime}:00`);
                const diffMs = Math.abs(sellDateTime - buyDateTime);
                let holdDisplay;
                const days = Math.floor(diffMs / (86400000)); // 1000*60*60*24
                const hours = Math.floor((diffMs % 86400000) / 3600000); // 1000*60*60
                const minutes = Math.round(((diffMs % 86400000) % 3600000) / 60000); // 1000*60
                if (days > 0) holdDisplay = `${days}d ${hours}h`;
                else if (hours > 0) holdDisplay = `${hours}h ${minutes}m`;
                else holdDisplay = `${minutes}m`;


                const profitClass = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-5 py-4">${index + 1}</td>
                        <td class="px-5 py-4">${trade.buyDate} @ ${trade.buyTime}</td>
                        <td class="px-5 py-4">$${trade.buyPrice.toFixed(2)}</td>
                        <td class="px-5 py-4">${trade.sellDate} @ ${trade.sellTime}</td>
                        <td class="px-5 py-4">$${trade.sellPrice.toFixed(2)}</td>
                        <td class="px-5 py-4 ${profitClass} font-medium">$${trade.profit.toFixed(2)}</td>
                        <td class="px-5 py-4">${holdDisplay}</td>
                    </tr>`;
                tradeLogBody.innerHTML += row;
            });
            
            const finalPositionEl = document.getElementById('final-position');
            const finalPositionText = document.getElementById('final-position-text');
            if (finalOpenPosition) {
                finalPositionText.textContent = `The simulation ended with an open position bought on ${finalOpenPosition.buyDate} at $${finalOpenPosition.buyPrice.toFixed(2)}.`;
                finalPositionEl.classList.remove('hidden');
            } else {
                finalPositionEl.classList.add('hidden');
            }

            displayChart(trades, intradayData);
        }

        // --- Main App Logic ---

        function setupUI() {
            const strategySelect = document.getElementById('strategy-select');
            const smaControls = document.getElementById('sma-controls');
            const rsiControls = document.getElementById('rsi-controls');
            const bollingerControls = document.getElementById('bollinger-controls');
            const strategyDescription = document.getElementById('strategy-description');

            const descriptions = {
                sma: '<strong>SMA Crossover Only:</strong> Buys when the shorter-term moving average crosses above the longer-term one. Very selective, only trades in strong uptrends.',
                rsi: '<strong>RSI Only:</strong> Buys whenever the RSI drops below the "Oversold" level. More frequent trades, but can be risky in a downtrend ("catching a falling knife").',
                hybrid: '<strong>SMA Filter + RSI Entry:</strong> Uses the SMA Crossover to confirm a long-term uptrend, then uses RSI to find a good "buy the dip" entry point within that trend.',
                bollinger: '<strong>Bollinger Bands:</strong> Buys when the price touches or crosses below the lower band, suggesting the asset is oversold and likely to revert to its mean (average price). Works in most market conditions.'
            };

            function updateControls() {
                const selected = strategySelect.value;
                smaControls.style.display = (selected === 'sma' || selected === 'hybrid') ? 'grid' : 'none';
                rsiControls.style.display = (selected === 'rsi' || selected === 'hybrid') ? 'grid' : 'none';
                bollingerControls.style.display = (selected === 'bollinger') ? 'grid' : 'none';
                strategyDescription.innerHTML = descriptions[selected];
            }

            strategySelect.addEventListener('change', updateControls);
            document.getElementById('run-button').addEventListener('click', runSimulation);
            updateControls(); // Initial setup
        }
        
        async function runSimulation() {
            const runButton = document.getElementById('run-button');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const resultsContainer = document.getElementById('results-container');
            const summary = document.getElementById('summary');
            const tradeLogContainer = document.getElementById('trade-log-container');
            const chartContainer = document.getElementById('chart-container');
            const errorMessage = document.getElementById('error-message');
            
            runButton.disabled = true;
            errorMessage.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            summary.classList.add('hidden');
            tradeLogContainer.classList.add('hidden');
            chartContainer.classList.add('hidden');
            loader.style.display = 'flex';
            loaderText.textContent = 'Preparing simulation...';

            try {
                await initDB();
                // Common parameters
                const ticker = document.getElementById('ticker-input').value.toUpperCase();
                const apiKey = document.getElementById('api-key').value;
                const investmentAmount = parseFloat(document.getElementById('investment-amount').value);
                const profitPercentage = parseFloat(document.getElementById('profit-percent').value);
                const stopLossPercentage = parseFloat(document.getElementById('stop-loss-percent').value);
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const strategy = document.getElementById('strategy-select').value;

                // Validation
                if (!ticker || !apiKey || !startDate || !endDate) throw new Error("Please fill all required fields.");
                if (isNaN(investmentAmount) || isNaN(profitPercentage) || isNaN(stopLossPercentage)) throw new Error("Please enter valid numbers for investment, profit, and stop-loss.");
                if (new Date(startDate) >= new Date(endDate)) throw new Error("The 'From' date must be before the 'To' date.");

                // Fetch data
                const dailyPrices = await fetchDailyData(ticker, apiKey, (progress) => loaderText.textContent = progress);
                
                // Calculate all indicators we might need
                const dailyIndicators = { prices: dailyPrices };
                const backtestParams = { 
                    strategy, profitPercentage, stopLossPercentage, investmentAmount, dailyIndicators
                };

                if (strategy === 'sma' || strategy === 'hybrid') {
                    const fastSma = parseInt(document.getElementById('fast-sma').value, 10);
                    const slowSma = parseInt(document.getElementById('slow-sma').value, 10);
                    dailyIndicators.smas = calculateSMAs(dailyPrices, fastSma, slowSma);
                }
                if (strategy === 'rsi' || strategy === 'hybrid') {
                    const rsiPeriod = parseInt(document.getElementById('rsi-period').value, 10);
                    dailyIndicators.rsi = calculateRSI(dailyPrices, rsiPeriod);
                    backtestParams.rsiOversold = parseInt(document.getElementById('rsi-oversold').value, 10);
                }
                if (strategy === 'bollinger') {
                    const period = parseInt(document.getElementById('bollinger-period').value, 10);
                    const stddev = parseFloat(document.getElementById('bollinger-stddev').value);
                    dailyIndicators.bollinger = calculateBollingerBands(dailyPrices, period, stddev);
                }

                // Fetch intraday data
                const intradayData = await fetchIntradayData(ticker, startDate, endDate, apiKey, (progress) => loaderText.textContent = progress);
                const filteredIntradayData = Object.keys(intradayData)
                    .filter(date => date >= startDate && date <= endDate)
                    .reduce((obj, key) => { obj[key] = intradayData[key]; return obj; }, {});

                if (Object.keys(filteredIntradayData).length === 0) {
                    throw new Error("No intraday data was found for the selected date range.");
                }
                backtestParams.intradayData = filteredIntradayData;

                // Run backtest
                loaderText.textContent = 'Running backtest...';
                const backtestResults = runBacktest(backtestParams);
                
                // Display results
                displayResults(backtestResults, filteredIntradayData);
                summary.classList.remove('hidden');
                tradeLogContainer.classList.remove('hidden');
                chartContainer.classList.remove('hidden');

            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
                runButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', setupUI);

    </script>
</body>
</html>
